name: æ„å»ºEXEæ–‡ä»¶

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # æ˜ç¡®æˆäºˆå†™å…¥æƒé™

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¡ç®—ç‰ˆæœ¬å·
        id: version
        run: |
          # è®¡ç®—è¯­ä¹‰åŒ–ç‰ˆæœ¬å· va.b.c
          # åˆå§‹å€¼: a=2, b=0, c=0 (v2.0.0)
          # æ¯æ¬¡æäº¤ c+1ï¼Œc>=10 æ—¶ c=0 ä¸” b+1ï¼Œb>=10 æ—¶ b=0 ä¸” a+1
          
          $runNumber = ${{ github.run_number }}
          $totalIncrements = $runNumber - 1
          
          $c = $totalIncrements % 10
          $bIncrements = [math]::Floor($totalIncrements / 10)
          $b = $bIncrements % 10
          $aIncrements = [math]::Floor($bIncrements / 10)
          $a = 2 + $aIncrements
          
          $version = "v$a.$b.$c"
          
          Write-Host "ğŸ·ï¸ è®¡ç®—å¾—åˆ°ç‰ˆæœ¬å·: $version"
          Write-Host "ğŸ“Š è®¡ç®—è¯¦æƒ…:"
          Write-Host "   - Run Number: $runNumber"
          Write-Host "   - Total Increments: $totalIncrements"
          Write-Host "   - a: $a, b: $b, c: $c"
          
          # è¾“å‡ºç»™åç»­æ­¥éª¤ä½¿ç”¨
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "major=$a" >> $env:GITHUB_OUTPUT
          echo "minor=$b" >> $env:GITHUB_OUTPUT
          echo "patch=$c" >> $env:GITHUB_OUTPUT

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ç¼“å­˜Pythonä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller
          pip install -r requirements.txt

      - name: åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        run: |
          echo "æ„å»ºæ—¶é—´: $(Get-Date)" > build_info.txt
          echo "ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}" >> build_info.txt
          echo "ç‰ˆæœ¬è¯¦æƒ…: ${{ steps.version.outputs.major }}.${{ steps.version.outputs.minor }}.${{ steps.version.outputs.patch }}" >> build_info.txt
          echo "æäº¤å“ˆå¸Œ: ${{ github.sha }}" >> build_info.txt
          echo "æ„å»ºç¼–å·: ${{ github.run_number }}" >> build_info.txt

      - name: ä½¿ç”¨PyInstalleræ„å»ºEXE
        run: |
          pyinstaller --onefile --name mzzb_score --console --clean --distpath dist --workpath build --optimize 2 main.py

      - name: éªŒè¯æ„å»ºç»“æœ
        run: |
          if (Test-Path "dist/mzzb_score.exe") {
            Write-Host "âœ… EXEæ–‡ä»¶æ„å»ºæˆåŠŸ"
            $fileSize = (Get-Item "dist/mzzb_score.exe").Length / 1MB
            Write-Host "ğŸ“¦ æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
            Write-Host "ğŸ·ï¸ ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}"
          } else {
            Write-Host "âŒ EXEæ–‡ä»¶æ„å»ºå¤±è´¥"
            exit 1
          }

      - name: ä¸Šä¼ æ„å»ºç»“æœåˆ°Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mzzb_score-${{ steps.version.outputs.version }}
          path: |
            dist/mzzb_score.exe
            build_info.txt
          retention-days: 30

      - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/mzzb_score.exe
            build_info.txt
          name: "${{ steps.version.outputs.version }}"
          tag_name: "${{ steps.version.outputs.version }}"
          body: |
            ## ğŸ‰ è¯„åˆ†ç»Ÿè®¡å·¥å…·æ–°ç‰ˆæœ¬å‘å¸ƒ

            ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
            - **ç‰ˆæœ¬å·**: ${{ steps.version.outputs.version }}
            - **ä¸»ç‰ˆæœ¬**: ${{ steps.version.outputs.major }}
            - **æ¬¡ç‰ˆæœ¬**: ${{ steps.version.outputs.minor }}
            - **ä¿®è®¢ç‰ˆæœ¬**: ${{ steps.version.outputs.patch }}
            - **æ„å»ºç¼–å·**: ${{ github.run_number }}
            - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            - **æäº¤å“ˆå¸Œ**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})

            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            ä¸‹è½½ `mzzb_score.exe` æ–‡ä»¶å³å¯ç›´æ¥è¿è¡Œï¼Œæ— éœ€å®‰è£…Pythonç¯å¢ƒã€‚

            ### ğŸ”„ ç‰ˆæœ¬è§„åˆ™
            - ç‰ˆæœ¬æ ¼å¼ï¼š`va.b.c`
            - æ¯æ¬¡æäº¤ä¿®è®¢ç‰ˆæœ¬ `c` åŠ 1
            - å½“ `c â‰¥ 10` æ—¶ï¼Œ`c` é‡ç½®ä¸º0ï¼Œæ¬¡ç‰ˆæœ¬ `b` åŠ 1  
            - å½“ `b â‰¥ 10` æ—¶ï¼Œ`b` é‡ç½®ä¸º0ï¼Œä¸»ç‰ˆæœ¬ `a` åŠ 1

            ### ğŸ”— ç›¸å…³é“¾æ¥
            - [æºä»£ç ](https://github.com/${{ github.repository }})
            - [ä½¿ç”¨è¯´æ˜](https://github.com/${{ github.repository }}/blob/main/README.md)
            - [æ‰€æœ‰ç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases)

            ---
            *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ„å»ºå®Œæˆé€šçŸ¥
        if: success()
        run: |
          Write-Host "ğŸ‰ æ„å»ºå’Œå‘å¸ƒå®Œæˆï¼"
          Write-Host "ğŸ“¦ ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}"
          Write-Host "ğŸ·ï¸ æ ‡ç­¾: ${{ steps.version.outputs.version }}"
          Write-Host "ğŸ”— ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"