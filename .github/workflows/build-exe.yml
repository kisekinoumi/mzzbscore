name: æ„å»ºEXEæ–‡ä»¶

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

env:
  PYTHONIOENCODING: utf-8
  PYTHONLEGACYWINDOWSSTDIO: utf-8

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # æ˜ç¡®æˆäºˆå†™å…¥æƒé™

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¡ç®—ç‰ˆæœ¬å·
        id: version
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          # è®¡ç®—è¯­ä¹‰åŒ–ç‰ˆæœ¬å· va.b.c
          # åˆå§‹å€¼: a=2, b=0, c=0 (v2.0.0)
          # æ¯æ¬¡æäº¤ c+1ï¼Œc>=10 æ—¶ c=0 ä¸” b+1ï¼Œb>=10 æ—¶ b=0 ä¸” a+1
          
          $runNumber = ${{ github.run_number }}
          $totalIncrements = $runNumber - 1
          
          $c = $totalIncrements % 10
          $bIncrements = [math]::Floor($totalIncrements / 10)
          $b = $bIncrements % 10
          $aIncrements = [math]::Floor($bIncrements / 10)
          $a = 2 + $aIncrements
          
          $version = "v$a.$b.$c"
          
          Write-Host "ğŸ·ï¸ è®¡ç®—å¾—åˆ°ç‰ˆæœ¬å·: $version"
          Write-Host "ğŸ“Š è®¡ç®—è¯¦æƒ…:"
          Write-Host "   - Run Number: $runNumber"
          Write-Host "   - Total Increments: $totalIncrements"
          Write-Host "   - a: $a, b: $b, c: $c"
          
          # è¾“å‡ºç»™åç»­æ­¥éª¤ä½¿ç”¨
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "major=$a" >> $env:GITHUB_OUTPUT
          echo "minor=$b" >> $env:GITHUB_OUTPUT
          echo "patch=$c" >> $env:GITHUB_OUTPUT

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ç¼“å­˜Pythonä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: å®‰è£…ä¾èµ–
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          python -m pip install --upgrade pip
          python -m pip install pyinstaller
          Write-Host "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
          pip install -r requirements.txt
          Write-Host "ä¾èµ–å®‰è£…å®Œæˆ"
          
          # éªŒè¯å…³é”®ä¾èµ–
          Write-Host "ğŸ” éªŒè¯å…³é”®ä¾èµ–..."
          python -c "import twscrape; print('OK: twscrape imported')"
          python -c "import asyncio; print('OK: asyncio imported')"
          python -c "import pandas; print('OK: pandas imported')"
          python -c "import openpyxl; print('OK: openpyxl imported')"
          python -c "import requests; print('OK: requests imported')"
        env:
          PYTHONIOENCODING: utf-8

      - name: é¢„ä¸‹è½½fake_useragentæ•°æ®
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Write-Host "ğŸ“¦ æ­£åœ¨é¢„ä¸‹è½½fake_useragentæ•°æ®..."
          python -c "
          import sys
          import os
          import shutil
          from pathlib import Path
          
          # è®¾ç½®UTF-8ç¼–ç è¾“å‡º
          if sys.platform == 'win32':
              import io
              sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
              sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')
          
          try:
              from fake_useragent import UserAgent
              ua = UserAgent()
              ua.random
              print('[SUCCESS] fake_useragentæ•°æ®ä¸‹è½½å®Œæˆ')
              
              import fake_useragent
              fa_path = Path(fake_useragent.__file__).parent
              data_dir = fa_path / 'data'
              
              if data_dir.exists():
                  project_data_dir = Path('fake_useragent_data')
                  if project_data_dir.exists():
                      shutil.rmtree(project_data_dir)
                  shutil.copytree(data_dir, project_data_dir)
                  print(f'[SUCCESS] æ•°æ®æ–‡ä»¶å·²å¤åˆ¶åˆ°: {project_data_dir}')
                  
                  for file in project_data_dir.rglob('*'):
                      if file.is_file():
                          print(f'[FILE] {file}')
              else:
                  print('[WARNING] æœªæ‰¾åˆ°dataç›®å½•')
          except Exception as e:
              print(f'[ERROR] å‡†å¤‡fake_useragentæ•°æ®å¤±è´¥: {e}')
              os.makedirs('fake_useragent_data', exist_ok=True)
              print('[INFO] åˆ›å»ºäº†æœ€å°æ•°æ®ç›®å½•')
          "
        env:
          PYTHONIOENCODING: utf-8

      - name: éªŒè¯fake_useragentæ•°æ®
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Write-Host "ğŸ” éªŒè¯fake_useragentæ•°æ®..."
          if (Test-Path fake_useragent_data) {
              Write-Host "[SUCCESS] fake_useragent_dataç›®å½•å­˜åœ¨"
              Get-ChildItem -Recurse fake_useragent_data | ForEach-Object { Write-Host "[FILE] $($_.FullName)" }
          } else {
              Write-Host "[ERROR] fake_useragent_dataç›®å½•ä¸å­˜åœ¨"
          }
        env:
          PYTHONIOENCODING: utf-8

      - name: åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          echo "æ„å»ºæ—¶é—´: $(Get-Date)" > build_info.txt
          echo "ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}" >> build_info.txt
          echo "ç‰ˆæœ¬è¯¦æƒ…: ${{ steps.version.outputs.major }}.${{ steps.version.outputs.minor }}.${{ steps.version.outputs.patch }}" >> build_info.txt
          echo "æäº¤å“ˆå¸Œ: ${{ github.sha }}" >> build_info.txt
          echo "æ„å»ºç¼–å·: ${{ github.run_number }}" >> build_info.txt

      - name: é¢„æ„å»ºæ£€æŸ¥
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Write-Host "ğŸ” æ£€æŸ¥æ¨¡å—å¯¼å…¥..."
          python -c "import sys; print('Python version:', sys.version)"
          python -c "import asyncio; print('OK: asyncio imported')"
          python -c "import twscrape; print('OK: twscrape imported')"
          python -c "import src.extractors; print('OK: src.extractors imported')"
          python -c "import src.parsers; print('OK: src.parsers imported')"
          python -c "import src.data_process; print('OK: src.data_process imported')"
          python -c "import utils; print('OK: utils imported')"
          python -c "import models; print('OK: models imported')"
          Write-Host "æ‰€æœ‰æ¨¡å—å¯¼å…¥æˆåŠŸ"
        env:
          PYTHONIOENCODING: utf-8

      - name: ä½¿ç”¨PyInstalleræ„å»ºEXE
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Write-Host "ğŸ”§ æ­£åœ¨æ„å»ºEXEæ–‡ä»¶..."
          pyinstaller --onefile --name mzzb_score --console --clean --distpath dist --workpath build --optimize 2 `
            --add-data "fake_useragent_data/*;fake_useragent/data/" `
            --hidden-import=asyncio `
            --hidden-import=twscrape `
            --hidden-import=twscrape.api `
            --hidden-import=twscrape.gather `
            --hidden-import=fake_useragent.data `
            --hidden-import=fake_useragent.utils `
            --hidden-import=fake_useragent.errors `
            --hidden-import=fake_useragent.settings `
            --hidden-import=src.extractors `
            --hidden-import=src.parsers `
            --hidden-import=src.data_process `
            --hidden-import=aiohttp `
            --hidden-import=lxml `
            --hidden-import=pandas `
            --hidden-import=openpyxl `
            --hidden-import=concurrent.futures `
            --hidden-import=threading `
            --hidden-import=json `
            --hidden-import=urllib.parse `
            --hidden-import=html `
            --collect-all=twscrape `
            --collect-all=asyncio `
            --collect-submodules=src `
            --collect-submodules=utils `
            --collect-submodules=models `
            main.py
          Write-Host "æ„å»ºå®Œæˆ"
        env:
          PYTHONIOENCODING: utf-8

      - name: éªŒè¯æ„å»ºç»“æœ
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          if (Test-Path "dist/mzzb_score.exe") {
            Write-Host "EXEæ–‡ä»¶æ„å»ºæˆåŠŸ"
            $fileSize = (Get-Item "dist/mzzb_score.exe").Length / 1MB
            Write-Host "ğŸ“¦ æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
            Write-Host "ğŸ·ï¸ ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}"
            
            # éªŒè¯Excelæ–‡ä»¶æ˜¯å¦å­˜åœ¨
            Write-Host "ğŸ“Š éªŒè¯Excelæ–‡ä»¶..."
            $excelFiles = @("mzzb.xlsx", "Xæœˆæ–°ç•ªé¦–æœˆè¯„åˆ†.xlsx", "Xæœˆæ–°ç•ªå®Œç»“è¯„åˆ†.xlsx")
            foreach ($file in $excelFiles) {
              if (Test-Path $file) {
                $excelSize = (Get-Item $file).Length / 1KB
                Write-Host "   OK: $file - $([math]::Round($excelSize, 1)) KB"
              } else {
                Write-Host "   ERROR: $file - æ–‡ä»¶ä¸å­˜åœ¨"
                exit 1
              }
            }
            
            # éªŒè¯EXEæ–‡ä»¶çš„ä¾èµ–
            Write-Host "ğŸ” éªŒè¯EXEæ–‡ä»¶ä¾èµ–..."
            $dependencies = @("kernel32.dll", "user32.dll", "msvcrt.dll")
            foreach ($dep in $dependencies) {
              Write-Host "   - ${dep}: ç³»ç»Ÿä¾èµ–"
            }
            
            # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
            Write-Host "ğŸ§ª éªŒè¯æ–‡ä»¶å®Œæ•´æ€§..."
            if (Get-Command "Get-FileHash" -ErrorAction SilentlyContinue) {
              $hash = Get-FileHash "dist/mzzb_score.exe" -Algorithm SHA256
              Write-Host "ğŸ“ æ–‡ä»¶å“ˆå¸Œ: $($hash.Hash.Substring(0,16))..."
            }
            
            Write-Host "æ„å»ºéªŒè¯å®Œæˆ"
          } else {
            Write-Host "ERROR: EXEæ–‡ä»¶æ„å»ºå¤±è´¥"
            exit 1
          }
        env:
          PYTHONIOENCODING: utf-8

      - name: åŸºç¡€åŠŸèƒ½æµ‹è¯•
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Write-Host "ğŸ§ª æµ‹è¯•exeåŸºæœ¬åŠŸèƒ½..."
          try {
              $process = Start-Process -FilePath "dist\mzzb_score.exe" -Wait -PassThru -NoNewWindow -RedirectStandardOutput "test_output.txt" -RedirectStandardError "test_error.txt"
              Write-Host "[TEST] exeè¿›ç¨‹é€€å‡ºä»£ç : $($process.ExitCode)"
              Write-Host "[OUTPUT] è¾“å‡ºå†…å®¹:"
              if (Test-Path "test_output.txt") { Get-Content "test_output.txt" }
              Write-Host "[ERROR] é”™è¯¯å†…å®¹:"
              if (Test-Path "test_error.txt") { Get-Content "test_error.txt" }
          } catch {
              Write-Host "[WARNING] æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸: $($_.Exception.Message)"
              Write-Host "[INFO] è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºç¼ºå°‘Excelæ–‡ä»¶"
          }
        env:
          PYTHONIOENCODING: utf-8

      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Write-Host "ğŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
          
          # ä¸ºé¿å…GitHub APIçš„ä¸­æ–‡ç¼–ç é—®é¢˜ï¼Œé‡å‘½åExcelæ–‡ä»¶
          if (Test-Path "Xæœˆæ–°ç•ªé¦–æœˆè¯„åˆ†.xlsx") {
            Copy-Item "Xæœˆæ–°ç•ªé¦–æœˆè¯„åˆ†.xlsx" "monthly_anime_scores.xlsx"
            Write-Host "   OK: é‡å‘½åé¦–æœˆè¯„åˆ†æ–‡ä»¶"
          }
          
          if (Test-Path "Xæœˆæ–°ç•ªå®Œç»“è¯„åˆ†.xlsx") {
            Copy-Item "Xæœˆæ–°ç•ªå®Œç»“è¯„åˆ†.xlsx" "final_anime_scores.xlsx"  
            Write-Host "   OK: é‡å‘½åå®Œç»“è¯„åˆ†æ–‡ä»¶"
          }
          
          Write-Host "æ–‡ä»¶å‡†å¤‡å®Œæˆ"

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Write-Host "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          if (Test-Path "fake_useragent_data") {
              Remove-Item -Recurse "fake_useragent_data"
              Write-Host "[INFO] å·²åˆ é™¤fake_useragent_dataç›®å½•"
          }
          if (Test-Path "test_output.txt") { Remove-Item "test_output.txt" }
          if (Test-Path "test_error.txt") { Remove-Item "test_error.txt" }

      - name: ä¸Šä¼ æ„å»ºç»“æœåˆ°Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mzzb_score-${{ steps.version.outputs.version }}
          path: |
            dist/mzzb_score.exe
            build_info.txt
            mzzb.xlsx
            monthly_anime_scores.xlsx
            final_anime_scores.xlsx
          retention-days: 30

      - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/mzzb_score.exe
            mzzb.xlsx
            monthly_anime_scores.xlsx
            final_anime_scores.xlsx
          name: "${{ steps.version.outputs.version }}"
          tag_name: "${{ steps.version.outputs.version }}"
          body: |
            ### ğŸ¯ ç‰ˆæœ¬ä¿¡æ¯
            - **æ„å»ºç¼–å·**: ${{ github.run_number }}
            - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            - **æäº¤å“ˆå¸Œ**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})

            ### ğŸ“‹ ä½¿ç”¨è¯´æ˜
            1. ä¸‹è½½ `mzzb_score.exe` æ–‡ä»¶å³å¯ç›´æ¥è¿è¡Œï¼Œæ— éœ€å®‰è£…Pythonç¯å¢ƒ
            2. ä½¿ç”¨æä¾›çš„Excelæ¨¡æ¿æ–‡ä»¶ï¼š
               - **mzzb.xlsx** - ä¸»è¦çš„æ•°æ®æ–‡ä»¶æ¨¡æ¿
               - **monthly_anime_scores.xlsx** - é¦–æœˆè¯„åˆ†ç»Ÿè®¡æ¨¡æ¿
               - **final_anime_scores.xlsx** - å®Œç»“è¯„åˆ†ç»Ÿè®¡æ¨¡æ¿
            3. åœ¨Excelæ–‡ä»¶ä¸­å¡«å…¥åŠ¨ç”»åç§°ï¼Œå¯é€‰æ‹©é¢„å¡«å¹³å°é“¾æ¥
            4. è¿è¡Œç¨‹åºï¼Œæ ¹æ®æç¤ºé…ç½®TwitteråŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
            5. ç¨‹åºä¼šè‡ªåŠ¨è·å–å„å¹³å°è¯„åˆ†æ•°æ®å¹¶æ›´æ–°Excelæ–‡ä»¶

            ### ğŸ“ ä¸‹è½½æ–‡ä»¶è¯´æ˜
            - ğŸ“‹ **mzzb_score.exe** - ä¸»ç¨‹åºæ–‡ä»¶
            - ğŸ“Š **mzzb.xlsx** - æ•°æ®è¾“å…¥æ¨¡æ¿
            - ğŸ¯ **monthly_anime_scores.xlsx** - é¦–æœˆè¯„åˆ†ç»Ÿè®¡æ¨¡æ¿ï¼ˆXæœˆæ–°ç•ªé¦–æœˆè¯„åˆ†ï¼‰
            - ğŸ† **final_anime_scores.xlsx** - å®Œç»“è¯„åˆ†ç»Ÿè®¡æ¨¡æ¿ï¼ˆXæœˆæ–°ç•ªå®Œç»“è¯„åˆ†ï¼‰
            
            ---
            *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ„å»ºå®Œæˆé€šçŸ¥
        if: success()
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Write-Host "ğŸ‰ æ„å»ºå’Œå‘å¸ƒå®Œæˆï¼"
          Write-Host "ğŸ“¦ ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}"
          Write-Host "ğŸ·ï¸ æ ‡ç­¾: ${{ steps.version.outputs.version }}"
          Write-Host "ğŸ”— ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
          Write-Host ""
          Write-Host "ğŸ“ å·²å‘å¸ƒçš„æ–‡ä»¶:"
          Write-Host "   - mzzb_score.exe (ä¸»ç¨‹åº)"
          Write-Host "   - mzzb.xlsx (æ•°æ®è¾“å…¥æ¨¡æ¿)"
          Write-Host "   - monthly_anime_scores.xlsx (é¦–æœˆè¯„åˆ†æ¨¡æ¿)"
          Write-Host "   - final_anime_scores.xlsx (å®Œç»“è¯„åˆ†æ¨¡æ¿)"