name: Build EXE with fake_useragent fix

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Pre-download fake_useragent data
      run: |
        echo "æ­£åœ¨é¢„ä¸‹è½½fake_useragentæ•°æ®..."
        python -c "
        try:
            from fake_useragent import UserAgent
            import os
            import shutil
            from pathlib import Path
            
            # åˆå§‹åŒ–UserAgentï¼Œè§¦å‘æ•°æ®ä¸‹è½½
            ua = UserAgent()
            ua.random  # è§¦å‘æ•°æ®ä¸‹è½½
            print('âœ… fake_useragentæ•°æ®ä¸‹è½½å®Œæˆ')
            
            # æ‰¾åˆ°æ•°æ®æ–‡ä»¶ä½ç½®å¹¶å¤åˆ¶
            import fake_useragent
            fa_path = Path(fake_useragent.__file__).parent
            data_dir = fa_path / 'data'
            
            if data_dir.exists():
                # å¤åˆ¶åˆ°é¡¹ç›®ç›®å½•
                project_data_dir = Path('fake_useragent_data')
                if project_data_dir.exists():
                    shutil.rmtree(project_data_dir)
                shutil.copytree(data_dir, project_data_dir)
                print(f'âœ… æ•°æ®æ–‡ä»¶å·²å¤åˆ¶åˆ°: {project_data_dir}')
                
                # åˆ—å‡ºå¤åˆ¶çš„æ–‡ä»¶
                for file in project_data_dir.rglob('*'):
                    if file.is_file():
                        print(f'ğŸ“ {file}')
            else:
                print('âš ï¸  æœªæ‰¾åˆ°dataç›®å½•')
                
        except Exception as e:
            print(f'âŒ å‡†å¤‡fake_useragentæ•°æ®å¤±è´¥: {e}')
            # åˆ›å»ºä¸€ä¸ªæœ€å°çš„æ•°æ®ç›®å½•
            import os
            os.makedirs('fake_useragent_data', exist_ok=True)
            print('ğŸ“ åˆ›å»ºäº†æœ€å°æ•°æ®ç›®å½•')
        "
    
    - name: Verify fake_useragent data
      run: |
        echo "éªŒè¯fake_useragentæ•°æ®..."
        if (Test-Path fake_useragent_data) {
            echo "âœ… fake_useragent_dataç›®å½•å­˜åœ¨"
            Get-ChildItem -Recurse fake_useragent_data | ForEach-Object { echo "ğŸ“ $($_.FullName)" }
        } else {
            echo "âŒ fake_useragent_dataç›®å½•ä¸å­˜åœ¨"
        }
    
    - name: Build EXE with PyInstaller
      run: |
        echo "æ­£åœ¨ç¼–è¯‘exeæ–‡ä»¶..."
        pyinstaller --onefile --console --name mzzbscore `
          --add-data "fake_useragent_data/*;fake_useragent/data/" `
          --hidden-import fake_useragent.data `
          --hidden-import fake_useragent.utils `
          --hidden-import fake_useragent.errors `
          --hidden-import fake_useragent.settings `
          --hidden-import twscrape `
          --hidden-import twscrape.api `
          --hidden-import twscrape.gather `
          --hidden-import asyncio `
          --hidden-import aiohttp `
          --hidden-import lxml `
          --hidden-import pandas `
          --hidden-import openpyxl `
          --hidden-import concurrent.futures `
          --hidden-import threading `
          --hidden-import json `
          --hidden-import urllib.parse `
          --hidden-import html `
          --collect-submodules src `
          --collect-submodules utils `
          --collect-submodules models `
          main.py
    
    - name: Verify build output
      run: |
        echo "éªŒè¯ç¼–è¯‘è¾“å‡º..."
        if (Test-Path dist\mzzbscore.exe) {
            $size = (Get-Item dist\mzzbscore.exe).Length / 1MB
            echo "âœ… ç¼–è¯‘æˆåŠŸï¼æ–‡ä»¶å¤§å°: $([math]::Round($size, 1)) MB"
            echo "ğŸ“ æ–‡ä»¶ä½ç½®: $(Get-Item dist\mzzbscore.exe | Select-Object -ExpandProperty FullName)"
        } else {
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªæ‰¾åˆ°exeæ–‡ä»¶"
            exit 1
        }
    
    - name: Test EXE basic functionality
      run: |
        echo "æµ‹è¯•exeåŸºæœ¬åŠŸèƒ½..."
        # åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œæ£€æŸ¥exeæ˜¯å¦èƒ½å¯åŠ¨å¹¶è¯†åˆ«ç¼ºå°‘Excelæ–‡ä»¶
        # æ³¨æ„ï¼šè¿™é‡Œå¯èƒ½ä¼šå› ä¸ºç¼ºå°‘Excelæ–‡ä»¶è€Œå¤±è´¥ï¼Œä½†è¿™æ˜¯é¢„æœŸçš„
        try {
            $process = Start-Process -FilePath "dist\mzzbscore.exe" -Wait -PassThru -NoNewWindow -RedirectStandardOutput "test_output.txt" -RedirectStandardError "test_error.txt"
            echo "ğŸ§ª exeè¿›ç¨‹é€€å‡ºä»£ç : $($process.ExitCode)"
            echo "ğŸ“„ è¾“å‡ºå†…å®¹:"
            if (Test-Path "test_output.txt") { Get-Content "test_output.txt" }
            echo "ğŸ“„ é”™è¯¯å†…å®¹:"
            if (Test-Path "test_error.txt") { Get-Content "test_error.txt" }
        } catch {
            echo "âš ï¸  æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸: $($_.Exception.Message)"
            echo "ğŸ’¡ è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºç¼ºå°‘Excelæ–‡ä»¶"
        }
    
    - name: Upload EXE artifact
      uses: actions/upload-artifact@v4
      with:
        name: mzzbscore-exe
        path: dist/mzzbscore.exe
        
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs
        path: |
          build/
          test_output.txt
          test_error.txt
        
    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/mzzbscore.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}